<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Morse Code Translator</title>

  <style>
    /* ---------- Global page styling ---------- */
    body {
      font-family: 'Courier New', Courier, monospace;  /* retro terminal vibe   */
      background-color: #0a0a0a;                       /* dark theme background */
      color: #e0e0e0;                                  /* light gray text       */
      display: flex;                                   /* center page contents  */
      flex-direction: column;
      align-items: center;
      padding: 40px;
    }

    /* ---------- Title ---------- */
    h1 {
      font-size: 2.5em;
      color: #fff;
      margin-bottom: 10px;
      text-shadow: 0 0 10px #fff;   /* subtle glow */
    }

    /* ---------- GIF container ---------- */
    .gif-container {                /* centers the image & adds spacing */
      margin: 20px 0;
    }
    .gif-container img {
      width: 220px;                 /* fixed width keeps layout stable  */
      border-radius: 10px;          /* soft rounded corners             */
      box-shadow: 0 0 20px #fff;    /* white glow around the GIF        */
    }

    /* ---------- Form / input styling ---------- */
    form {
      margin: 20px 0;
    }
    input[type="text"] {
      width: 300px;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #fff;       /* white border for contrast        */
      background: #111;
      color: #fff;
      border-radius: 6px;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      margin-left: 10px;
      background-color: #fff;       /* white button with black text     */
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {                  /* highlight on hover               */
      background-color: #ff0000;
    }

    /* ---------- Received-message panel ---------- */
    #received {
      margin-top: 40px;
      padding: 20px;
      background: #111;
      border: 2px solid #fff;
      border-radius: 10px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 0 15px #ff0000; /* red glow matches send btn hover  */
    }
    #received h3 {
      margin-top: 0;
      color: #fff;
    }
    #receivedText {
      font-family: 'Courier New', monospace;
      font-size: 1.2em;
      white-space: pre-wrap;        /* preserve line breaks             */
      color: #ff0000;
    }

    /* ---------- Signal-light (visual flash) ---------- */
    .signal-light {
      margin-top: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #222;             /* dark circle when idle            */
      box-shadow: 0 0 10px #fff;    /* faint glow                      */
      transition: background 0.3s, box-shadow 0.3s;
    }
    .signal-light.on {              /* class toggled in JS (flash)      */
      background: #fff;             /* bright white                     */
      box-shadow: 0 0 20px #fff, 0 0 60px #fff;
    }
  </style>
</head>

<body>
  <h1>Morse Code Web Chat</h1>

  <div class="gif-container">
    <img src="https://media1.tenor.com/m/0wNFACbg25wAAAAC/code-morse.gif" alt="Morse Code GIF">
  </div>

  <form id="sendForm">
    <input type="text" id="messageInput" placeholder="Enter message to send" required />
    <button type="submit">Send</button>
  </form>

  <div class="signal-light" id="lightIndicator"></div>

  <div id="received">
    <h3>Received Message:</h3>
    <pre id="receivedText">Waiting...</pre> </div>

  <script>
    // --- Configuration ---
    const SERVER_URL = `http://${window.location.hostname}:5000`;
    const POLLING_INTERVAL = 3000; // Interroger toutes les 3000 ms (3 secondes)

    // --- Références aux éléments HTML ---
    const messageInput = document.getElementById('messageInput');
    const receivedTextElement = document.getElementById('receivedText');
    const lightIndicator = document.getElementById('lightIndicator');

    // --- Fonction pour envoyer un message au serveur ---
   async function sendMessage(msg) {
      if (!msg.trim()) return;

      const body = new URLSearchParams({
        msg,
        sender: "web"     // Balise d'origine pour les messages envoyés depuis la page web
      });

      const response = await fetch(`${SERVER_URL}/send`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      console.log("Message envoyé avec succès.");
      fetchMessage(); // Rafraîchir l’affichage après envoi
    }

    // --- Fonction pour faire clignoter l'indicateur lumineux ---
    function flashLight(duration) {
      if (lightIndicator) {
         lightIndicator.classList.add('on');
         setTimeout(() => {
             lightIndicator.classList.remove('on');
         }, duration);
       } else {
           console.error("Element 'lightIndicator' non trouvé.");
       }
    }

    // --- Fonction pour récupérer le dernier message du serveur ---
    async function fetchMessage() {
        if (!receivedTextElement) {
             console.error("Element 'receivedTextElement' non trouvé.");
             return;
        }
        try {
            const response = await fetch(`${SERVER_URL}/get`);
            if (!response.ok) {
                console.error(`Erreur HTTP lors de la récupération: ${response.status}`);
                return;
            }
            const data = await response.json();
            if (data && data.sender === "web") {
                console.log("Le message actuel sur le serveur provient de 'web'. L'affichage n'est pas mis à jour avec ce message.");
            } else if (data && data.msg) {
                if (data.sender) {
                    receivedTextElement.textContent = `${data.sender}: ${data.msg}`;
                } else {
                    receivedTextElement.textContent = data.msg;
                }
            } else if (data && data.message) { // Fallback pour l'ancien format au cas où
                 receivedTextElement.textContent = data.message;
            }
            else {
                receivedTextElement.textContent = "Waiting...";
            }

        } catch (err) {
            console.error("Erreur réseau lors de la récupération du message:", err);
             if (receivedTextElement) {
                receivedTextElement.textContent = "[Erreur réseau]";
             }
        }
    }

    // --- Écouteur d'événement pour l'envoi du formulaire ---
    document.getElementById("sendForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const messageToSend = messageInput.value;

      if (!messageToSend.trim()) {
          alert("Veuillez entrer un message.");
          return;
      }

      try {
        await sendMessage(messageToSend);
        flashLight(500);
        messageInput.value = "";
      } catch (err) {
        alert("Erreur lors de l'envoi: " + err.message);
      }
    });

    // --- Démarrage du Polling ---
    if (receivedTextElement) {
        fetchMessage(); // Appel initial
        setInterval(fetchMessage, POLLING_INTERVAL);
        console.log("Logique client initialisée. Polling démarré.");
    } else {
        console.error("Impossible de démarrer le polling: élément 'receivedText' non trouvé.");
    }

  </script>

</body>
</html>